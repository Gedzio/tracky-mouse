<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self' 'unsafe-inline' blob:"
    />
    <title>Tracky Mouse</title>
    <script src="core/lib/stats.js"></script>
    <script src="core/lib/no-eval.js"></script>
    <script src="core/lib/clmtrackr.js"></script>
    <!-- <script src="../node_modules/tracky-mouse/lib/jsfeat-min.js"></script> exported from patched clmtrackr.js -->
    <style>
      body {
        background-color: white;
        color: black;
      }

      @media (prefers-color-scheme: dark) {
        body {
          background-color: black;
          color: white;
        }

        a:link {
          color: aquamarine;
        }

        a:visited {
          color: rgb(197, 127, 255);
        }
      }

      html,
      body,
      .tracky-mouse-ui {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        /* Don't need min height when height of the container is 100%,
			and don't want it because it can make the camera view get pushed
			off-screen, making the media query's breakpoint highly dependent
			on the UI. Without a min height, it's flexible, it's just a matter
			of how small the camera view gets. If the settings take up a lot of
			height, it might shrink to nothing, but it'll never get cut off. */
        --tracky-mouse-camera-view-min-height: 0;
      }

      @media screen and (max-height: 500px) {
        /* TODO: provide modal access to settings when window is small,
			i.e. a button that shows the settings over/replacing the camera feed.
			right now, this hides the settings and there's no indication that they exist */
        .tracky-mouse-controls {
          display: none;
        }

        .tracky-mouse-ui.tracky-mouse-ui {
          padding: 0;
          --tracky-mouse-camera-view-min-height: 0;
        }
      }
    </style>
    <link rel="stylesheet" type="text/css" href="core/tracky-mouse.css" />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="images/tracky-mouse-logo-16.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="512x512"
      href="images/tracky-mouse-logo-512.png"
    />
  </head>

  <body>
    <script src="core/tracky-mouse.js"></script>
    <script>
      TrackyMouse.dependenciesRoot = "core";
      TrackyMouse.init();

      // Language Selector Logic
      (async () => {
        const uiContainer = document.body; // Or find a specific container if TrackyMouse renders into one

        const langContainer = document.createElement("div");
        langContainer.style.position = "absolute";
        langContainer.style.top = "10px";
        langContainer.style.right = "10px";
        langContainer.style.zIndex = "10000";
        langContainer.style.backgroundColor = "rgba(255, 255, 255, 0.8)";
        langContainer.style.padding = "5px";
        langContainer.style.borderRadius = "5px";
        langContainer.style.display = "flex";
        langContainer.style.alignItems = "center";
        langContainer.style.gap = "10px";

        const flagImg = document.createElement("img");
        flagImg.style.width = "32px";
        flagImg.style.height = "32px";

        const select = document.createElement('select');
        
        const modes = [
          { val: 'pl', text: 'Polish' },
          { val: 'en-c', text: 'English Command' },
          { val: 'en-d', text: 'English Dictation' },
          { val: 'en-m', text: 'English Mix' },
          { val: 'sleep', text: 'Sleep' },
          { val: 'off', text: 'Turn Off' }
        ];

        modes.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m.val;
          opt.innerText = m.text;
          select.appendChild(opt);
        });

        langContainer.appendChild(flagImg);
        langContainer.appendChild(select);
        document.body.appendChild(langContainer);

        let currentLang = 'pl';
        let currentEnabled = true;

        const updateUI = () => {
          select.value = currentLang;
          // New icon naming convention: icon-mode-<mode>[-active].png
          const suffix = currentEnabled ? '-active' : '';
          flagImg.src = `../images/icon-mode-${currentLang}${suffix}.png`;
        };

        // Initialize
        if (window.electronAPI) {
          window.electronAPI.getLanguage().then(lang => {
            currentLang = lang;
            window.electronAPI.getTrackingState().then(enabled => {
               currentEnabled = enabled;
               updateUI();
            });
          });

          select.addEventListener('change', (e) => {
            currentLang = e.target.value;
            window.electronAPI.setLanguage(currentLang);
            updateUI(); // Optimistic update
          });

          window.electronAPI.onLanguageChanged((lang) => {
            currentLang = lang;
            updateUI();
          });

          window.electronAPI.onTrackingStateChanged((enabled) => {
             currentEnabled = enabled;
             updateUI();
          });
        }
      })();
    </script>
  </body>
</html>
